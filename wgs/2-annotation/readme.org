#+TITLE: Annotation
#+PROPERTY:  header-args :var DIR=(my/dir)

#+name:genomes
| Name | Fasta                         |
|------+-------------------------------|
| Kc   | 1-assembly/5-curate/Kc.fa.gz  |
| Kd   | 1-assembly/5-curate/Kd.fa.gz  |
| Kk   | 1-assembly/5-curate/Kk.fa.gz  |
| Gk   | 1-assembly/0-ref/kirkii.fa.gz |

* Repeats

- Run RepeatModeler
   #+header: :var genomes=genomes
  #+begin_src sh :tangle 1-repeats/1-modeler.sh
     ROOT=$(git rev-parse --show-toplevel)
     ml singularity

     line=$(sed -n ${SLURM_ARRAY_TASK_ID}p <<<"$genomes")
     read name fasta <<<"$line"

     export BLAST_USAGE_REPORT=false

     SCRATCH=/local/scratch/tony.arick/$SLURM_JOB_ID/
     cd $SCRATCH

     singularity exec -B $ROOT -B $SCRATCH $DIR/apps/dfam-tetools-1.87.sif \
                 BuildDatabase -name $SCRATCH/$name.db $ROOT/wgs/$fasta
     singularity exec -B $ROOT -B $SCRATCH $DIR/apps/dfam-tetools-1.87.sif \
                 RepeatModeler -database $SCRATCH/$name.db \
                 -threads 48 -LTRStruct

     mkdir $DIR/1-repeats/$name/
     cp -r $SCRATCH $DIR/1-repeats/$name/modeler
  #+end_src

  #+RESULTS:

- Run RepeatMasker
   #+header: :var genomes=genomes
  #+begin_src sh :tangle 1-repeats/2-masker.sh
ROOT=$(git rev-parse --show-toplevel)
ml singularity

line=$(sed -n ${SLURM_ARRAY_TASK_ID}p <<<"$genomes")
read name fasta <<<"$line"

export BLAST_USAGE_REPORT=false

SCRATCH=/local/scratch/tony.arick/$SLURM_JOB_ID/
cd $SCRATCH

zcat -f $ROOT/wgs/$fasta > $SCRATCH/$name.fa

singularity exec -B $ROOT -B $SCRATCH $DIR/apps/dfam-tetools-1.87.sif \
            RepeatMasker -pa 48 \
                          -lib $DIR/1-repeats/$name/modeler/$name.db-families.fa \
                           $SCRATCH/$name.fa

cp -r $SCRATCH $DIR/1-repeats/$name/masker

  #+end_src

* Braker3
#+header: :var genomes=genomes[,0]
#+begin_src sh :tangle 2-braker3/run.sh
  ROOT=$(git rev-parse --show-toplevel)
  name=$(sed -n ${SLURM_ARRAY_TASK_ID}p <<<"$genomes")

  ml singularity

  SCRATCH=/local/scratch/tony.arick/$SLURM_JOB_ID/
  mkdir $DIR/2-braker3/$name
  cd $DIR/2-braker3/$name

  mkdir $DIR/2-braker3/$name/home
  cp $HOME/.gm_key $DIR/2-braker3/$name/home

  singularity exec --cleanenv -H $DIR/2-braker3/$name/home \
                   -B $ROOT -B $SCRATCH \
              $DIR/apps/braker3_v.1.0.4.1.sif braker.pl \
                  --species=$name \
                  --genome=$DIR/1-repeats/$name/masker/$name.fa.masked \
                  --prot_seq=$DIR/2-braker3/Viridiplantae.fa \
                  --threads=48 \
                  --workingdir=$SCRATCH
  cp -r $SCRATCH $DIR/2-braker3/$name/output

#+end_src

#+RESULTS:

* Rename
:PROPERTIES:
:ORDERED:  t
:END:
#+header: :var genomes=genomes
  #+begin_src sh :tangle 3-rename.sh
    ROOT=$(git rev-parse --show-toplevel)

      declare -A names 
      names["Kc"]="Kocoo"
      names["Kk"]="Kokau"
      names["Kd"]="Kodry"
      names["Gk"]="Gokir"

      cat <<<"$genomes" |
          grep 'Kc' |
          while read i fasta; do
              cp $ROOT/wgs/$fasta $DIR/${names[$i]}.fa.gz
              
  #            tar -O -xf 2-braker3/$i.tar braker.gtf |
              cat $DIR/2-braker3/$i/output/braker.gtf |
                  awk '$1 != chr { chr=$1; c=1;
                                   num=$1; sub(".._", "0", num);
                                   num=substr(num, length(num)-2, 3)
                       }
                       $3 == "gene" {
                           name = $9;
                           rep=sprintf("%s.%03sG%04d00", spec, num, c++)
                       }
                       1 { gsub(name, rep, $9);
                           sub("\\.t", ".", $9);
                           print }' \
                      FS="\t" OFS="\t" spec=${names[$i]} |
                      gzip > $DIR/${names[$i]}.gtf.gz
          done
  #+end_src


- Graph

  #+begin_src R 
    library(tidyverse)

    data <- list.files(pattern=".gtf.gz") %>%
      setNames(substring(., 0,5)) %>%
      lapply(data.table::fread) %>%
      bind_rows(.id='Species') %>%
      filter(V3 == "gene") %>%
      mutate(chr = substring(V1, 4)) %>%
      group_by(Species, chr) %>%
      count()

    data %>%
      mutate(chr = factor(chr, c('01', '2_4', '03',
                                 sprintf('%02d', 5:13)))) %>%
    ggplot(aes(chr, n, shape=Species, color=Species)) +
      geom_point(position=position_dodge(width=0.5)) +
      scale_y_continuous(limits=c(0,4600), expand=c(0,0),
                         name="Number of Genes") +
      scale_x_discrete(expand=c(0,0), name="Chromosome") +
      theme_minimal() +
      theme(panel.grid.major.x=element_blank())

    ggsave('gene-counts.png', width=12, height=4, bg='white')
  #+end_src
[[./gene-counts.png]]
